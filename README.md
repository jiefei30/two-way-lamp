# 双向流水灯

>  程序编写于2019年的单片机课程设计

## 设计目的及要求：
### 设计要求：
要求8个发光管从左向右移动点亮，或者从右向左移动点亮，每次点亮2个发光管，移动速度可调，左右变换周期也是可调的。
### 发挥部分：
具有控制按钮能控制同时亮1盏、2盏或3盏灯，顺时针同时亮2盏灯的亮灯顺序为：12→23→34→45→56→61→12…. ，其余类推。

## 设计方案
利用8051单片机P0口连接八个发光二极管，高电平驱动。P2口连接五个开关按键(仿真实物为4×4矩阵按键)来控制流水灯的左右变化周期、移动速度以及亮灯个数。

## 电路设计
P0接8个发光二极管，高电平驱动，RP1为排阻。

P2口用来实现4×4的矩阵，此设计是为了实物电路板而设计的。

前5个功能分别是加减变换周期、加减移动速度、控制亮灯个数。

![](https://file.makeyourchoice.cn/img/github/danpianji1.png)

## 主要程序设计及解释
首先需要使用中断，因为仅靠delay函数对灯的移动进行控制，会导致在灯的延迟时按键失灵（代码执行不到），故采用中断。
代码主要分3大块：
- 按键检测函数
- 中断函数
- 灯移动函数

三个函数的作用均是修改灯的变量参数。

## 演示结果
### 1

中断设计为每2ms中断一次，用变量time储存中断次数，每中断一次time++，time每计够500即为1秒。
	
程序运行开始后初始默认亮左边的第一盏灯。（此时P0 = `all_lighting_condition[0][7]`）。

我们把灯的移动速度LED_speed初始为500，让time对LED_speed取余，每取余结果为0就调用一次LED_move方法：
	
LED_move方法中对LED_direction变量进行判断（0或1），实现向左或者向右亮灯，如果灯向右移动就让LED_which_lighting--，在对P0赋值，例如灯运动第一次时P0 = `all_lighting_condition[0][6]`。

当到`all_lighting_condition[0][0]` 时，再回到`all_lighting_condition[0][7]`，灯每移动1个位置，即速度初始为每1s让灯移动一个位置。

我们把灯方向的变换周期LED_cycle初始为5000，也让time对LED_cycle取余，每取余结果为0就让灯改变移动的方向（LED_direction = ~ LED_direction ，LED_move中的判断发生改变），即最左边的灯移动经过10s（移动10个位置后）移动后转变方向。
	
所以程序刚开始运行时再没有按任何按键的情况下，灯花费10秒向右移动10次后，再花费10秒向左移动回到最初的位置，再向右移动，往复循环。

![](https://file.makeyourchoice.cn/img/github/danpianji3.png)

### 2
按下cycle-up按键（即按键1），方向变换所需要的周期（时间）增加，即LED_cycle变量增大，这样time需要计到更大才会取LED_cycle为0。

按一次按键LED_cycle增大1000，即time要到6000（12s）时取LED_cycle才为0，即灯泡会向一个方向运动12s（如果速度为初始速度，则为移动12个位置）后才变换方向。

再按下按键后，LED_cycle再增大1000（2s），以此类推。当然程序中加的有判断，当LED_cycle为10000（20s）时就不能再增大了。

也就是说第一个按钮按够5次后，灯的变换周期已经到达了最大值10000，灯朝一个方向最多移动20s（以初始速度为20个位置）就会变换方向。

### 3
按下cycle-down按键（即按键2），方向变换所需要的周期（时间）减少。即LED_cycle变量减小，这样time计数更小就取LED_cycle为0。

按一次按键LED_cycle减小1000，即time计到4000（8s）时取LED_cycle才为0，即灯泡会向一个方向运动8s（如果速度为初始速度，则为移动8个位置）后就变换方向。

再按下按键后，LED_cycle再减小1000（2s），以此类推。当然程序中加的有判断，当LED_cycle为1000（2s）时就不能再减小了。

也就是说第二个按钮按够4次后，灯的变换周期已经到达了最小值1000，灯朝一个方向最少移动2s（以初始速度为2个位置）就会变换方向。

### 4
按下speed-up按键（即按键3），发光管移动的速度会不断增加。这里程序中LED_speed的值会减小，因为LED_speed越小，time对其取余为0的频率越高。

每按一次按键后，LED_speed的值减小100（0.2s），LED_speed的最小值为100，即灯移动的最快速度为每0.2秒移动一个位置。

### 5
按下speed-down按键（即按键4），发光管移动的速度会不断减少。这里程序中LED_speed的值会增大，因为LED_speed越大，time对其取余为0的频率越慢。

每按一次按键后，LED_speed的值增大100（0.2s），LED_speed的最大值为1000，即灯移动的最慢速度为每2秒移动一个位置。

### 6
按一次LED-number按键（即按键5），移动的发光管的个数会从1个变为2个，再按一次，移动的发光管的个数会从2个变为3个，再按由3个变回1个，

以此方式循环······这里的实现方法为用一个3x8的二维数组all_lighting_condition记录三个灯泡的所有共24种亮灯的情况（24个16进制数）,通过每次LED_move方法将all_lighting_condition中某一个值赋给P0。

all_lighting_condition的使用方法为P0 =` all_lighting_condition[LED_number][LED_which_lighting]`;

LED_number（0~2）为灯的个数（控制的是二维数组的行），LED_which_lighting(0~7)控制在该灯数（行）下，在哪个位置（列）量。

![](https://file.makeyourchoice.cn/img/github/danpianji2.png)





